<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LUXURY BY DARLIN ‚Äî Cat√°logo</title>
  <meta name="description" content="Cat√°logo de perfumes ‚Äî carrito y pedidos por WhatsApp." />

  <style>
    :root{
      /* LUXURY BY DARLIN ‚Äî Paleta clara oficial */
      --bg:#F8F5F0;        /* marfil */
      --panel:#EFE7DA;     /* beige arena */
      --card:#FFFFFF;      /* tarjetas */
      --card2:#F3EEE7;     /* superficies suaves */
      --text:#2B2622;      /* gris carb√≥n (m√°s ‚Äúnegro‚Äù) */
      --muted:#6F6860;     /* gris topo */
      --gold:#D9B87A;      /* champagne gold */
      --gold2:#EED9A6;     /* dorado claro */
      --line:#E3D8C8;      /* l√≠neas suaves */
      --shadow: 0 12px 28px rgba(17, 12, 7, .08);
      --shadow2: 0 10px 18px rgba(17, 12, 7, .06);
      --r:18px;
      --r2:24px;
      --focus: 0 0 0 4px rgba(217,184,122,.28);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      background:
        radial-gradient(1100px 650px at 15% -10%, rgba(217,184,122,.22), transparent 55%),
        radial-gradient(900px 520px at 110% 0%, rgba(217,184,122,.12), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.55), transparent 38%),
        var(--bg);
      color:var(--text);
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }

    input, select, textarea{font-family:inherit}
    .hidden{display:none !important;}

    /* ===== TOPBAR ===== */
    .topbar{
      position:sticky; top:0; z-index:10;
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      padding:14px 16px;
      background: rgba(248,245,240,.86);
      backdrop-filter: blur(12px);
      border-bottom:1px solid var(--line);
    }

    .brand{display:flex; align-items:center; gap:12px; min-width: 220px;}
    .logo{
      width:44px; height:44px; border-radius: 14px;
      display:grid; place-items:center;
      border:1px solid rgba(217,184,122,.55);
      background: linear-gradient(180deg, rgba(238,217,166,.85), rgba(217,184,122,.85));
      color:#ffffff;
      font-weight:950;
      box-shadow: var(--shadow2);
      user-select:none;
      -webkit-user-select:none;
      cursor: default;
    }
    .brand-text{min-width:0}
    .brand-name{letter-spacing:.18em; font-weight:950; font-size:12px; white-space:nowrap}
    .brand-sub{color:var(--muted); font-size:12px; margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 320px}

    .top-actions{display:flex; align-items:center; gap:10px; width:100%; max-width: 860px; justify-content:flex-end;}
    .search-wrap{flex:1; max-width:560px}
    .search-wrap input{
      width:100%;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.92);
      color:var(--text);
      outline:none;
      box-shadow: 0 1px 0 rgba(17,12,7,.02);
    }
    .search-wrap input::placeholder{color: rgba(111,104,96,.75)}
    .search-wrap input:focus{border-color: rgba(217,184,122,.7); box-shadow: var(--focus);}

    .btn{
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.92);
      color:var(--text);
      cursor:pointer;
      font-weight:900;
      letter-spacing:.02em;
      white-space:nowrap;
      box-shadow: 0 1px 0 rgba(17,12,7,.02);
    }
    .btn.primary{
      background: linear-gradient(180deg, rgba(238,217,166,.95), rgba(217,184,122,.95));
      border-color: rgba(217,184,122,.55);
      color:#2B2622;
    }
    .btn:hover{border-color: rgba(217,184,122,.75)}
    .btn:active{transform: translateY(1px)}

    .cart-btn{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.92);
      color:var(--text);
      cursor:pointer;
      box-shadow: 0 1px 0 rgba(17,12,7,.02);
      font-weight:950;
    }
    .cart-count{
      min-width: 22px; height: 22px; padding: 0 6px;
      border-radius: 999px;
      display:grid; place-items:center;
      background: rgba(217,184,122,.22);
      border:1px solid rgba(217,184,122,.55);
      color: var(--text);
      font-weight:950;
      font-size:12px;
    }

    /* ===== LAYOUT ===== */
    .layout{
      display:grid;
      grid-template-columns: 330px 1fr;
      gap:18px;
      padding: 16px;
      max-width: 1320px;
      margin: 0 auto;
    }

    /* ===== FILTERS ===== */
    .filters{
      position:sticky; top:78px; align-self:start;
      background: rgba(239,231,218,.82);
      border:1px solid var(--line);
      border-radius: var(--r2);
      padding:14px;
      box-shadow: var(--shadow);
    }
    .panel-title{
      font-weight:950;
      letter-spacing:.14em;
      font-size:12px;
      color: var(--text);
      margin: 4px 0 12px;
    }
    .field{display:flex; flex-direction:column; gap:6px; margin-bottom:10px;}
    .field span{font-size:12px; color:var(--muted); font-weight:800}
    .field select, .field input, .field textarea{
      padding:11px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.92);
      color:var(--text);
      outline:none;
    }
    .field textarea{min-height:140px; resize:vertical}
    .field select:focus, .field input:focus, .field textarea:focus{
      border-color: rgba(217,184,122,.7);
      box-shadow: var(--focus);
    }

    .note{
      margin-top: 10px;
      padding: 12px;
      border-radius: 16px;
      border: 1px dashed rgba(217,184,122,.60);
      color: var(--muted);
      background: rgba(255,255,255,.72);
    }
    .note-title{color:var(--text); font-weight:950; margin-bottom:6px}
    .hint{color:var(--muted); font-size:12px; margin-top:4px}

    /* ===== CONTENT ===== */
    .content-head{
      display:flex; align-items:flex-end; justify-content:space-between;
      padding: 4px 2px 12px;
      gap:10px;
    }
    .results{font-weight:950; color:var(--text)}

    .brands{display:flex; flex-direction:column; gap:14px;}
    .brand-section{
      background: rgba(255,255,255,.86);
      border:1px solid var(--line);
      border-radius: var(--r2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .brand-header{
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid var(--line);
      background: rgba(243,238,231,.82);
    }
    .brand-title{
      font-weight:950;
      letter-spacing:.06em;
      color:var(--text);
      font-size:14px;
      min-width:0;
    }
    .brand-pill{
      font-size:11px;
      padding:6px 10px;
      border-radius: 999px;
      border:1px solid rgba(217,184,122,.55);
      color: var(--text);
      background: rgba(217,184,122,.18);
      white-space:nowrap;
      font-weight:900;
    }
    .brand-body{padding: 12px 12px 12px;}
    .list{display:flex; flex-direction:column; gap:10px;}

    .item{
      background: rgba(255,255,255,.92);
      border:1px solid var(--line);
      border-radius: 18px;
      padding: 12px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }

    /* Imagen opcional */
    .item-media{
      width: 92px;
      height: 92px;
      border-radius: 16px;
      flex-shrink:0;
      border:1px solid rgba(217,184,122,.35);
      background:
        radial-gradient(120px 120px at 30% 20%, rgba(217,184,122,.18), transparent 55%),
        rgba(243,238,231,.7);
      overflow:hidden;
      display:grid;
      place-items:center;
    }
    .item-media img{
      width:100%;
      height:100%;
      object-fit: contain;
      display:block;
      background: transparent;
    }
    .media-ph{
      font-size:11px;
      color: rgba(111,104,96,.92);
      text-align:center;
      padding:8px;
      line-height:1.15;
      font-weight:800;
    }

    .item-left{min-width:0; flex:1}
    .item-name{
      margin:0 0 6px;
      font-weight:950;
      font-size:15px;
      line-height:1.15;
      color: var(--text);
    }
    .item-meta{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      color: var(--muted);
      font-size:12px;
    }
    .chip{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(227,216,200,.9);
      background: rgba(243,238,231,.9);
      font-weight:800;
      color: var(--text);
    }
    .chip.gold{
      border-color: rgba(217,184,122,.55);
      background: rgba(217,184,122,.18);
      color: var(--text);
      font-weight:900;
    }

    .item-note{
      margin-top:8px;
      color: var(--muted);
      font-size:12px;
      word-break: break-word;
      font-weight:700;
    }

    .item-actions{
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:flex-end;
      flex-shrink:0;
    }
    .add-btn{
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid rgba(217,184,122,.55);
      background: linear-gradient(180deg, rgba(238,217,166,.92), rgba(217,184,122,.92));
      color: var(--text);
      cursor:pointer;
      font-weight:950;
      white-space:nowrap;
      box-shadow: 0 8px 18px rgba(217,184,122,.18);
    }
    .add-btn:hover{border-color: rgba(217,184,122,.80)}
    .micro{
      font-size:11px;
      color:rgba(111,104,96,.92);
      text-align:right;
      max-width: 150px;
      font-weight:800;
    }

    /* Admin por item */
    .admin-row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
      margin-top: 2px;
    }
    .img-btn{
      font-size:11px;
      padding:7px 9px;
      border-radius: 12px;
      border:1px dashed rgba(217,184,122,.70);
      background: rgba(243,238,231,.9);
      color: var(--text);
      cursor:pointer;
      font-weight:950;
      white-space:nowrap;
    }
    .img-btn:hover{border-color: rgba(217,184,122,.90)}
    .danger-btn{
      font-size:11px;
      padding:7px 9px;
      border-radius: 12px;
      border:1px solid rgba(255,107,107,.38);
      background: rgba(255,107,107,.10);
      color: #b32626;
      cursor:pointer;
      font-weight:950;
    }

    /* Footer */
    .footer{
      max-width:1320px;
      margin: 18px auto 28px;
      padding: 0 16px;
      display:flex; justify-content:space-between; align-items:center;
      color: var(--muted);
      font-size: 12px;
      gap:12px;
      flex-wrap:wrap;
      font-weight:800;
    }

    /* Backdrop + Drawer */
    .backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.35);
      z-index: 30;
    }

    .drawer{
      position:fixed; top:0; right:0; bottom:0;
      width: min(460px, 92vw);
      background: rgba(248,245,240,.98);
      border-left:1px solid var(--line);
      z-index: 40;
      transform: translateX(105%);
      transition: transform .22s ease;
      display:flex; flex-direction:column;
      box-shadow: -18px 0 28px rgba(17,12,7,.10);
    }
    .drawer.open{transform: translateX(0)}
    .drawer-head{
      padding: 14px;
      display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
      border-bottom:1px solid var(--line);
      background: rgba(255,255,255,.75);
    }
    .drawer-title{font-weight:950; color: var(--text)}
    .drawer-sub{color:var(--muted); font-size:12px; margin-top:3px; font-weight:800}
    .icon-btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.92);
      color: var(--text);
      border-radius: 12px;
      width:38px; height:38px;
      cursor:pointer;
      font-weight:950;
    }
    .drawer-body{padding: 12px 14px; overflow:auto; flex:1;}
    .cart-item{
      padding: 10px 12px;
      border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.88);
      margin-bottom: 10px;
    }
    .ci-name{font-weight:950; font-size:13px; line-height:1.15; color:var(--text)}
    .ci-meta{color:var(--muted); font-size:12px; margin-top:4px; font-weight:750}
    .qty-row{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:10px}
    .qty-controls{display:flex; align-items:center; gap:8px}
    .qbtn{
      width:34px; height:34px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(243,238,231,.9);
      color: var(--text);
      cursor:pointer;
      font-weight:950;
    }
    .qval{min-width: 22px; text-align:center; font-weight:950}
    .rm{
      border:1px solid rgba(255,107,107,.30);
      background: rgba(255,107,107,.10);
      color: #b32626;
      padding: 0 10px;
      width:auto;
      white-space:nowrap;
    }
    .drawer-foot{
      padding: 14px;
      border-top:1px solid var(--line);
      background: rgba(255,255,255,.75);
    }

    /* Modal */
    .modal{
      position:fixed; inset:0;
      z-index:60;
      display:grid;
      place-items:center;
      background: rgba(0,0,0,.35);
      padding:16px;
    }
    .modal-card{
      width:min(920px, 96vw);
      background: rgba(248,245,240,.98);
      border:1px solid var(--line);
      border-radius: var(--r2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal-head{
      padding:14px;
      display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
      border-bottom:1px solid var(--line);
      background: rgba(255,255,255,.75);
    }
    .modal-title{font-weight:950; color:var(--text)}
    .modal-sub{color:var(--muted); font-size:12px; margin-top:4px; font-weight:800}
    .modal-body{padding:14px}
    .row{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .row .btn{flex:1}

    /* Responsive */
    @media (max-width: 980px){
      .layout{grid-template-columns: 1fr; }
      .filters{position:relative; top:auto}
      .top-actions{max-width: 100%;}
      .micro{display:none}
      .brand-sub{max-width: 190px;}
    }
    @media (max-width: 560px){
      .brand{min-width:auto}
      .brand-sub{display:none}
      .topbar{padding:12px}
      .item{flex-direction:column;}
      .item-media{width:100%; height:170px;}
      .item-actions{
        flex-direction:row;
        justify-content:space-between;
        align-items:center;
        width:100%;
      }
      .admin-row{justify-content:flex-start;}
    }

    /* Admin UI */
    #adminPanel{display:none;}
  </style>
</head>

<body>
<header class="topbar">
  <div class="brand">
    <div class="logo" id="logo" aria-hidden="true" title="LUXURY BY DARLIN">L</div>
    <div class="brand-text">
      <div class="brand-name">LUXURY BY DARLIN</div>
      <div class="brand-sub">Cat√°logo ‚Ä¢ Carrito ‚Ä¢ Pedido por WhatsApp</div>
    </div>
  </div>

  <div class="top-actions">
    <div class="search-wrap">
      <input id="searchInput" type="search" placeholder="Buscar por perfume o marca‚Ä¶" autocomplete="off" />
    </div>

    <div id="adminPanel">
      <button id="importBtn" class="btn" type="button" title="Solo admin">ADMIN</button>
    </div>

    <button id="cartBtn" class="cart-btn" type="button" aria-label="Abrir carrito">
      <span aria-hidden="true">üõí</span>
      <span class="cart-count" id="cartCount">0</span>
    </button>
  </div>
</header>

<main class="layout">
  <aside class="filters">
    <div class="panel-title">Filtros</div>

    <label class="field">
      <span>Marca</span>
      <select id="brandSelect"></select>
    </label>

    <label class="field">
      <span>G√©nero</span>
      <select id="genderSelect"></select>
    </label>

    <label class="field">
      <span>Tama√±o (ml)</span>
      <select id="sizeSelect"></select>
    </label>

    <label class="field">
      <span>Tipo (EDT/EDP/Parfum‚Ä¶)</span>
      <select id="typeSelect"></select>
    </label>

    <label class="field">
      <span>Orden</span>
      <select id="sortSelect">
        <option value="brand">Marca (A‚ÄìZ)</option>
        <option value="name">Nombre (A‚ÄìZ)</option>
      </select>
    </label>

    <button id="clearFilters" class="btn" type="button">Limpiar filtros</button>

    <div class="note">
      <div class="note-title">Pedidos</div>
      <p style="margin:0;font-weight:700">Los precios se consultan v√≠a WhatsApp. Agrega tus perfumes al carrito y env√≠a el pedido.</p>
    </div>

    </div>
  </aside>

  <section class="content">
    <div class="content-head">
      <div class="result-meta">
        <div class="results" id="resultsCount">0 productos</div>
        <div class="hint">Cat√°logo ordenado por marca. Usa b√∫squeda o filtros.</div>
      </div>
    </div>

    <div id="brands" class="brands"></div>
  </section>
</main>

<div id="drawerBackdrop" class="backdrop hidden"></div>

<aside id="cartDrawer" class="drawer" aria-label="Carrito">
  <div class="drawer-head">
    <div>
      <div class="drawer-title">Tu carrito</div>
      <div class="drawer-sub">Se enviar√° por WhatsApp a +1 (829) 475-5065</div>
    </div>
    <button id="closeCart" class="icon-btn" type="button" aria-label="Cerrar">‚úï</button>
  </div>

  <div id="cartItems" class="drawer-body"></div>

  <div class="drawer-foot">
    <label class="field">
      <span>Nombre (opcional)</span>
      <input id="customerName" type="text" placeholder="Ej. Darlin" />
    </label>
    <label class="field">
      <span>Zona/Direcci√≥n (opcional)</span>
      <input id="customerZone" type="text" placeholder="Ej. Cabarete" />
    </label>
    <label class="field">
      <span>Nota (opcional)</span>
      <input id="customerNote" type="text" placeholder="Ej. Si hay alguna recomendaci√≥n similar, env√≠amela" />
    </label>

    <button id="sendWhatsApp" class="btn primary" type="button">Enviar pedido por WhatsApp</button>
    <button id="clearCart" class="btn" type="button">Vaciar carrito</button>
  </div>
</aside>

<footer class="footer">
  <div>¬© <span id="year"></span> LUXURY BY DARLIN</div>
  <div>Cat√°logo m√≥vil ‚Ä¢ Carrito real ‚Ä¢ WhatsApp</div>
</footer>

<div id="importModal" class="modal hidden" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-label="Administraci√≥n de cat√°logo">
    <div class="modal-head">
      <div>
        <div class="modal-title">Modo Admin</div>
        <div class="modal-sub">
          Importa/Exporta tu cat√°logo. Acepta 6ta columna opcional: <b>image_url</b>. Tambi√©n puedes cargar el archivo <b>catalogo.txt</b>.
        </div>
      </div>
      <button id="closeImport" class="icon-btn" type="button" aria-label="Cerrar">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="note" style="margin-top:0">
        <div class="note-title">Cargar archivo catalogo.txt (recomendado para pruebas)</div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center">
          <input id="fileCatalog" type="file" accept=".txt,text/plain" />
          <button id="loadFileBtn" class="btn" type="button">Cargar archivo</button>
        </div>
        <div class="hint" style="margin-top:8px">Esto funciona aunque el navegador bloquee el fetch cuando abres el HTML descargado.</div>
      </div>

      <label class="field" style="margin-top:12px">
        <span>Pega aqu√≠ (1 l√≠nea = 1 producto)</span>
        <textarea id="importText" placeholder="Ej:
Afnan | 9 AM Dive EDP | 100ml | Unisex | Consultar v√≠a WhatsApp | https://.../imagen.jpg"></textarea>
      </label>

      <div class="row">
        <button id="doImport" class="btn primary" type="button">Importar</button>
        <button id="clearCatalog" class="btn" type="button">Borrar cat√°logo (local)</button>
        <button id="exportCatalog" class="btn" type="button">Exportar (copiar)</button>
        <button id="downloadCatalogTxt" class="btn" type="button">Descargar catalogo.txt</button>
      </div>

      <div class="hint" style="margin-top:10px">
        Tip PRO: Para que TODOS vean im√°genes y cat√°logo igual en cualquier tel√©fono, usa <b>Descargar catalogo.txt</b> y reemplaza ese archivo en tu GitHub (repo oficial).
      </div>
    </div>
  </div>
</div>

<script>
/* ===================== CONFIG ===================== */
const WHATSAPP_NUMBER = "18294755065";
const DEFAULT_NOTE = "Consultar v√≠a WhatsApp";

const LS_CATALOG_V1 = "LBD_CATALOG_V1";
const LS_CATALOG = "LBD_CATALOG_V2";
const LS_CART = "LBD_CART_V1";

const CATALOG_TXT_PATH = "./catalogo.txt";

/* Admin */
const ADMIN_SECRET = "Luxury 2026";
let isAdmin = false;

/* ===================== UTILS ===================== */
const el = (id)=>document.getElementById(id);
const norm = (s)=> (s ?? "").toString().trim();
const uniq = (arr)=> Array.from(new Set(arr)).filter(v=>v!=null && v!=="").sort((a,b)=>a.localeCompare(b,"es"));

function slug(s){
  return norm(s).toLowerCase()
    .replace(/[^\p{L}\p{N}]+/gu,"-")
    .replace(/^-+|-+$/g,"");
}
function parseMl(value){
  const s = norm(value);
  if(!s) return null;
  const m = s.match(/(\d{1,4})\s*ml/i);
  if(m) return Number(m[1]);
  const n = s.match(/(\d{1,4})/);
  return n ? Number(n[1]) : null;
}
function splitPipes(line){
  return line.split(/[|ÔΩú¬¶‚îÇ]/).map(p=>p.trim());
}

/* Detecta tipo desde el nombre (solo si aparece) */
function detectType(name){
  const s = norm(name).toUpperCase();
  const types = ["EXTRAIT","ELIXIR","PARFUM","EDP","EDT","COLOGNE","INTENSE"];
  for(const t of types){
    const re = new RegExp(`\\b${t}\\b`, "i");
    if(re.test(s)) return t;
  }
  return "N/D";
}

/* ===================== STORAGE ===================== */
function loadCatalogLocal(){
  try{
    const raw = localStorage.getItem(LS_CATALOG);
    if(raw){
      const parsed = JSON.parse(raw);
      return Array.isArray(parsed) ? parsed : [];
    }
  }catch{}
  return [];
}
function saveCatalogLocal(){
  localStorage.setItem(LS_CATALOG, JSON.stringify(ALL));
}
function loadCart(){
  try{
    const raw = localStorage.getItem(LS_CART);
    if(!raw) return {};
    const parsed = JSON.parse(raw);
    return parsed && typeof parsed==="object" ? parsed : {};
  }catch{
    return {};
  }
}
function saveCart(){
  localStorage.setItem(LS_CART, JSON.stringify(cart));
}

/* Migraci√≥n V1 -> V2 */
function migrateIfNeeded(){
  try{
    const v2 = localStorage.getItem(LS_CATALOG);
    if(v2) return;
    const v1raw = localStorage.getItem(LS_CATALOG_V1);
    if(!v1raw) return;
    const v1 = JSON.parse(v1raw);
    if(!Array.isArray(v1)) return;

    const upgraded = v1.map(p=>({
      ...p,
      image: p.image || null,
      type: p.type || detectType(p.name || ""),
    }));
    localStorage.setItem(LS_CATALOG, JSON.stringify(upgraded));
  }catch{}
}

/* ===================== DATA / STATE ===================== */
let ALL = [];
let filtered = [];
let cart = loadCart();

/* ===================== SORT / GROUP ===================== */
function sortCatalog(list, by="brand"){
  const arr = list.slice();
  if(by==="name"){
    return arr.sort((a,b)=> (a.name||"").localeCompare(b.name||"", "es"));
  }
  return arr.sort((a,b)=>{
    const br = (a.brand||"").localeCompare(b.brand||"", "es");
    if(br!==0) return br;
    return (a.name||"").localeCompare(b.name||"", "es");
  });
}
function groupByBrand(list){
  const map = new Map();
  for(const p of list){
    const b = p.brand || "Sin marca";
    if(!map.has(b)) map.set(b, []);
    map.get(b).push(p);
  }
  return map;
}

/* ===================== FILTERS ===================== */
function setOptions(select, values){
  select.innerHTML="";
  for(const v of values){
    const opt=document.createElement("option");
    opt.value=v;
    opt.textContent=v;
    select.appendChild(opt);
  }
}
function buildFilters(){
  const brands = ["Todas"].concat(uniq(ALL.map(p=>p.brand)));
  const genders = ["Todos"].concat(uniq(ALL.map(p=>p.gender)));
  const sizes = ["Todos"].concat(uniq(ALL.map(p=>p.size_ml).filter(x=>x!=null).map(x=>String(x))));
  const types = ["Todos"].concat(uniq(ALL.map(p=>p.type || "N/D")));

  setOptions(el("brandSelect"), brands);
  setOptions(el("genderSelect"), genders);
  setOptions(el("sizeSelect"), sizes);
  setOptions(el("typeSelect"), types);

  el("brandSelect").value="Todas";
  el("genderSelect").value="Todos";
  el("sizeSelect").value="Todos";
  el("typeSelect").value="Todos";
}

function applyFilters(){
  const q = norm(el("searchInput").value).toLowerCase();
  const brand = el("brandSelect").value;
  const gender = el("genderSelect").value;
  const size = el("sizeSelect").value;
  const type = el("typeSelect").value;
  const sortBy = el("sortSelect").value;

  filtered = ALL.filter(p=>{
    const matchQ = !q || (`${p.brand} ${p.name}`).toLowerCase().includes(q);
    const matchBrand = (brand==="Todas") || (p.brand===brand);
    const matchGender = (gender==="Todos") || (p.gender===gender);
    const matchSize = (size==="Todos") || (String(p.size_ml)===size);
    const matchType = (type==="Todos") || ((p.type||"N/D")===type);
    return matchQ && matchBrand && matchGender && matchSize && matchType;
  });

  filtered = sortCatalog(filtered, sortBy);
  renderBrands();
}

/* ===================== RENDER ===================== */
function renderBrands(){
  const wrap = el("brands");
  wrap.innerHTML="";
  el("resultsCount").textContent = `${filtered.length} productos`;

  const groups = groupByBrand(filtered);

  for(const [brand, items] of groups.entries()){
    const section = document.createElement("div");
    section.className = "brand-section";

    const head = document.createElement("div");
    head.className = "brand-header";

    const title = document.createElement("div");
    title.className = "brand-title";
    title.textContent = brand;

    const pill = document.createElement("div");
    pill.className = "brand-pill";
    pill.textContent = `${items.length} items`;

    head.appendChild(title);
    head.appendChild(pill);

    const body = document.createElement("div");
    body.className = "brand-body";

    const list = document.createElement("div");
    list.className = "list";

    for(const p of items){
      const item = document.createElement("div");
      item.className = "item";

      const media = document.createElement("div");
      media.className = "item-media";

      if(p.image){
        const img = document.createElement("img");
        img.loading = "lazy";
        img.decoding = "async";
        img.referrerPolicy = "no-referrer";
        img.alt = `${p.brand} ${p.name}`;
        img.src = p.image;
        img.onerror = ()=>{
          media.innerHTML = "";
          const ph = document.createElement("div");
          ph.className = "media-ph";
          ph.textContent = "Imagen no disponible";
          media.appendChild(ph);
        };
        media.appendChild(img);
      }else{
        const ph = document.createElement("div");
        ph.className = "media-ph";
        ph.textContent = "Sin imagen";
        media.appendChild(ph);
      }

      const left = document.createElement("div");
      left.className = "item-left";

      const name = document.createElement("div");
      name.className = "item-name";
      name.textContent = p.name;

      const meta = document.createElement("div");
      meta.className = "item-meta";

      const c1 = document.createElement("div");
      c1.className = "chip";
      c1.textContent = p.gender || "Unisex";

      const c2 = document.createElement("div");
      c2.className = "chip";
      c2.textContent = (p.size_ml!=null ? `${p.size_ml} ml` : "Tama√±o N/D");

      const c3 = document.createElement("div");
      c3.className = "chip gold";
      c3.textContent = p.type || "N/D";

      meta.appendChild(c1);
      meta.appendChild(c2);
      meta.appendChild(c3);

      const note = document.createElement("div");
      note.className = "item-note";
      note.textContent = p.note || DEFAULT_NOTE;

      left.appendChild(name);
      left.appendChild(meta);
      left.appendChild(note);

      const actions = document.createElement("div");
      actions.className = "item-actions";

      const add = document.createElement("button");
      add.className = "add-btn";
      add.type = "button";
      add.textContent = "A√±adir";
      add.addEventListener("click", ()=> addToCart(p.id));

      const micro = document.createElement("div");
      micro.className = "micro";
      micro.textContent = "Precio: por WhatsApp";

      actions.appendChild(add);
      actions.appendChild(micro);

      if(isAdmin){
        const adminRow = document.createElement("div");
        adminRow.className = "admin-row";

        const imgBtn = document.createElement("button");
        imgBtn.className = "img-btn";
        imgBtn.type = "button";
        imgBtn.textContent = p.image ? "Cambiar imagen" : "A√±adir imagen";
        imgBtn.addEventListener("click", ()=>{
          const url = prompt("Pega la URL DIRECTA de la imagen (jpg/png/webp):", p.image || "");
          if(url === null) return;
          const clean = norm(url);
          p.image = clean ? clean : null;
          saveCatalogLocal();
          applyFilters();
        });

        const clearImg = document.createElement("button");
        clearImg.className = "danger-btn";
        clearImg.type = "button";
        clearImg.textContent = "Quitar imagen";
        clearImg.addEventListener("click", ()=>{
          const ok = confirm("¬øQuitar imagen de este producto?");
          if(!ok) return;
          p.image = null;
          saveCatalogLocal();
          applyFilters();
        });

        adminRow.appendChild(imgBtn);
        adminRow.appendChild(clearImg);
        actions.appendChild(adminRow);
      }

      item.appendChild(media);
      item.appendChild(left);
      item.appendChild(actions);

      list.appendChild(item);
    }

    body.appendChild(list);
    section.appendChild(head);
    section.appendChild(body);
    wrap.appendChild(section);
  }
}

/* ===================== CART ===================== */
function updateCartCount(){
  const count = Object.values(cart).reduce((a,b)=>a+(b||0),0);
  el("cartCount").textContent = String(count);
}
function addToCart(id){
  cart[id] = (cart[id]||0) + 1;
  saveCart();
  updateCartCount();
}
function decFromCart(id){
  if(!cart[id]) return;
  cart[id]--;
  if(cart[id]<=0) delete cart[id];
  saveCart();
  updateCartCount();
  renderCart();
}
function incToCart(id){
  cart[id] = (cart[id]||0) + 1;
  saveCart();
  updateCartCount();
  renderCart();
}
function removeFromCart(id){
  delete cart[id];
  saveCart();
  updateCartCount();
  renderCart();
}
function renderCart(){
  const wrap = el("cartItems");
  wrap.innerHTML="";

  const byId = new Map(ALL.map(p=>[p.id,p]));
  const ids = Object.keys(cart);

  if(ids.length===0){
    wrap.innerHTML = `<div class="note"><div class="note-title">Carrito vac√≠o</div><div style="font-size:12px;color:var(--muted);font-weight:750">Agrega perfumes para armar tu pedido.</div></div>`;
    return;
  }

  for(const id of ids){
    const qty = cart[id];
    const p = byId.get(id);
    if(!p) continue;

    const item=document.createElement("div");
    item.className="cart-item";

    const title=document.createElement("div");
    title.className="ci-name";
    title.textContent = `${p.brand} ‚Äî ${p.name}`;

    const meta=document.createElement("div");
    meta.className="ci-meta";
    meta.textContent = `${p.gender||"Unisex"} ‚Ä¢ ${p.size_ml!=null? p.size_ml+"ml":"N/D"} ‚Ä¢ ${p.type||"N/D"} ‚Ä¢ ${p.note || DEFAULT_NOTE}`;

    const qtyRow=document.createElement("div");
    qtyRow.className="qty-row";

    const controls=document.createElement("div");
    controls.className="qty-controls";

    const minus=document.createElement("button");
    minus.className="qbtn";
    minus.type="button";
    minus.textContent="‚àí";
    minus.addEventListener("click", ()=> decFromCart(id));

    const val=document.createElement("div");
    val.className="qval";
    val.textContent=String(qty);

    const plus=document.createElement("button");
    plus.className="qbtn";
    plus.type="button";
    plus.textContent="+";
    plus.addEventListener("click", ()=> incToCart(id));

    controls.appendChild(minus);
    controls.appendChild(val);
    controls.appendChild(plus);

    const rm=document.createElement("button");
    rm.className="qbtn rm";
    rm.type="button";
    rm.textContent="Quitar";
    rm.addEventListener("click", ()=> removeFromCart(id));

    qtyRow.appendChild(controls);
    qtyRow.appendChild(rm);

    item.appendChild(title);
    item.appendChild(meta);
    item.appendChild(qtyRow);

    wrap.appendChild(item);
  }
}

/* ===================== OPEN/CLOSE ===================== */
function openCart(){
  el("drawerBackdrop").classList.remove("hidden");
  el("cartDrawer").classList.add("open");
  renderCart();
}
function closeCart(){
  el("drawerBackdrop").classList.add("hidden");
  el("cartDrawer").classList.remove("open");
}
function openImport(){
  if(!isAdmin) return;
  el("importModal").classList.remove("hidden");
  el("importModal").setAttribute("aria-hidden","false");
}
function closeImport(){
  el("importModal").classList.add("hidden");
  el("importModal").setAttribute("aria-hidden","true");
}

/* ===================== IMPORT PARSER ===================== */
/* Marca | Nombre | Tama√±o | G√©nero | Nota | image_url (opcional) */
function parseImport(text){
  const lines = text.split("\n").map(l=>l.trim()).filter(Boolean);
  const out = [];
  const seen = new Set();

  for(const line of lines){
    if(!/[|ÔΩú¬¶‚îÇ]/.test(line)) continue;

    const parts = splitPipes(line);
    if(parts.length >= 5){
      const brand = parts[0];
      const name = parts[1];
      const sizeText = parts[2];
      const gender = parts[3];
      const note = parts.slice(4,5).join(" | ").trim();
      const image = parts.length >= 6 ? parts.slice(5).join(" | ").trim() : "";

      const size_ml = parseMl(sizeText);
      const id = `${slug(brand)}-${slug(name)}-${size_ml||"x"}`;

      if(seen.has(id)) continue;
      seen.add(id);

      out.push({
        id,
        brand: brand || "Sin marca",
        name: name || "Sin nombre",
        gender: (gender && gender.trim()!=="") ? gender : "Unisex",
        size_ml: Number.isFinite(size_ml) ? size_ml : null,
        note: (note && note.trim()!=="") ? note : DEFAULT_NOTE,
        image: (image && image.trim()!=="") ? image : null,
        type: detectType(name || "")
      });
    }
  }
  return out;
}

function doImportFromTextarea(){
  if(!isAdmin) return;
  const text = el("importText").value;
  if(!norm(text)) return;

  const list = parseImport(text);
  if(list.length === 0){
    alert("No se import√≥ nada. Formato: Marca | Nombre | Tama√±o | G√©nero | Nota | image_url (opcional)");
    return;
  }

  ALL = sortCatalog(list, el("sortSelect").value || "brand");
  saveCatalogLocal();
  buildFilters();
  applyFilters();

  // limpiar carrito de ids inexistentes
  const ids = new Set(ALL.map(p=>p.id));
  for(const k of Object.keys(cart)){
    if(!ids.has(k)) delete cart[k];
  }
  saveCart();
  updateCartCount();
  renderCart();

  alert(`Listo: ${ALL.length} productos guardados. Para hacerlo GLOBAL, descarga catalogo.txt y s√∫belo a GitHub.`);
  closeImport();
}

function clearCatalogConfirm(){
  if(!isAdmin) return;
  const ok = confirm("¬øSeguro que quieres borrar el cat√°logo LOCAL de este dispositivo?");
  if(!ok) return;
  ALL = [];
  saveCatalogLocal();
  buildFilters();
  applyFilters();
}

function exportCatalogToClipboard(){
  if(!isAdmin) return;
  const lines = catalogToTxt(ALL);

  if(navigator.clipboard && navigator.clipboard.writeText){
    navigator.clipboard.writeText(lines).then(()=>{
      alert("Cat√°logo copiado. P√©galo donde quieras.");
    }).catch(()=>{
      el("importText").value = lines;
      alert("No pude copiar autom√°tico. Te lo dej√© en el cuadro para copiar manual.");
    });
  }else{
    el("importText").value = lines;
    alert("Tu navegador no permite copiar autom√°tico. Te lo dej√© en el cuadro para copiar manual.");
  }
}

/* ===================== CATALOG TXT (GLOBAL) ===================== */
function catalogToTxt(list){
  return list.map(p=>{
    const size = p.size_ml!=null ? `${p.size_ml}ml` : "";
    const gender = p.gender || "Unisex";
    const note = p.note || DEFAULT_NOTE;
    const image = p.image ? p.image : "";
    return `${p.brand} | ${p.name} | ${size} | ${gender} | ${note}${image ? " | " + image : ""}`;
  }).join("\n");
}

function downloadCatalogTxt(){
  if(!isAdmin) return;
  const content = catalogToTxt(ALL);
  const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "catalogo.txt";
  document.body.appendChild(a);
  a.click();
  a.remove();

  URL.revokeObjectURL(url);
}

async function loadCatalogFromTxtRemote(){
  try{
    const res = await fetch(CATALOG_TXT_PATH, { cache: "no-store" });
    if(!res.ok) return null;
    const text = await res.text();
    if(!text || !text.trim()) return null;

    const list = parseImport(text);
    if(!Array.isArray(list) || list.length===0) return null;

    return list;
  }catch{
    return null;
  }
}

/* Cargar catalogo.txt desde archivo local (para pruebas) */
async function loadCatalogFromFile(){
  if(!isAdmin) return;
  const input = el("fileCatalog");
  const file = input?.files?.[0];
  if(!file){
    alert("Selecciona primero un archivo catalogo.txt");
    return;
  }
  try{
    const text = await file.text();
    const list = parseImport(text);
    if(!list.length){
      alert("No pude leer el cat√°logo. Revisa el formato: Marca | Nombre | Tama√±o | G√©nero | Nota | image_url (opcional)");
      return;
    }
    ALL = sortCatalog(list, el("sortSelect").value || "brand");
    saveCatalogLocal();
    buildFilters();
    applyFilters();
    updateCartCount();
    alert(`Cat√°logo cargado desde archivo: ${ALL.length} productos.`);
    closeImport();
  }catch{
    alert("No pude leer el archivo. Intenta de nuevo.");
  }
}

async function hydrateCatalog(){
  migrateIfNeeded();

  // 1) intento remoto (global)
  const remote = await loadCatalogFromTxtRemote();
  if(remote && remote.length){
    ALL = remote;
    saveCatalogLocal();
    return;
  }

  // 2) fallback local
  ALL = loadCatalogLocal();
}

/* ===================== WHATSAPP ===================== */
function buildWhatsAppMessage(){
  const byId = new Map(ALL.map(p=>[p.id,p]));
  const items = Object.keys(cart).map(id=>{
    const qty = cart[id];
    const p = byId.get(id);
    if(!p) return null;
    const mlTxt = (p.size_ml!=null ? `${p.size_ml}ml` : "Tama√±o N/D");
    const genTxt = (p.gender || "Unisex");
    const typeTxt = (p.type || "N/D");
    return `‚Ä¢ ${qty} x ${p.brand} ‚Äî ${p.name} (${mlTxt}, ${genTxt}, ${typeTxt})`;
  }).filter(Boolean);

  const name = norm(el("customerName").value);
  const zone = norm(el("customerZone").value);
  const note = norm(el("customerNote").value);

  const lines = [];
  lines.push("üëã Hola, buenas.");
  lines.push("‚ú® Me gustar√≠a cotizar y hacer un pedido del siguiente listado:");
  lines.push("");
  lines.push(...items);
  lines.push("");
  if(name) lines.push(`üë§ Nombre: ${name}`);
  if(zone) lines.push(`üìç Zona/Direcci√≥n: ${zone}`);
  if(note) lines.push(`üìù Nota: ${note}`);
  lines.push("");
  lines.push("‚úÖ Quedo atento/a a disponibilidad y precio. ¬°Muchas gracias! üôè");

  return lines.join("\n");
}
function sendWhatsApp(){
  if(Object.keys(cart).length===0){
    alert("Tu carrito est√° vac√≠o.");
    return;
  }
  const msg = buildWhatsAppMessage();
  const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(msg)}`;
  window.open(url, "_blank");
}

/* ===================== ADMIN (UNLOCK) ===================== */
function showAdminUI(){
  isAdmin = true;
  el("adminPanel").style.display = "block";
}
function hideAdminUI(){
  isAdmin = false;
  el("adminPanel").style.display = "none";
  closeImport();
}

function requestAdminUnlock(){
  const clave = prompt("Introduce la clave secreta para activar el modo admin:");
  if(clave === ADMIN_SECRET){
    showAdminUI();
    alert("Modo admin activado (se desactiva al recargar/cerrar).");
    applyFilters();
  }else{
    alert("Clave incorrecta.");
  }
}

/* long-press en logo (5s) */
function wireLogoLongPress(){
  const logo = el("logo");
  if(!logo) return;

  let timer = null;
  const start = (e)=>{
    if(e && e.type === "contextmenu") e.preventDefault();
    clearTimeout(timer);
    timer = setTimeout(()=> requestAdminUnlock(), 5000);
  };
  const stop = ()=>{
    clearTimeout(timer);
    timer = null;
  };

  logo.addEventListener("pointerdown", start);
  logo.addEventListener("pointerup", stop);
  logo.addEventListener("pointercancel", stop);
  logo.addEventListener("pointerleave", stop);
  logo.addEventListener("contextmenu", (e)=> e.preventDefault());
}

/* ===================== EVENTS ===================== */
function wire(){
  el("year").textContent = String(new Date().getFullYear());

  el("searchInput").addEventListener("input", applyFilters);
  el("brandSelect").addEventListener("change", applyFilters);
  el("genderSelect").addEventListener("change", applyFilters);
  el("sizeSelect").addEventListener("change", applyFilters);
  el("typeSelect").addEventListener("change", applyFilters);
  el("sortSelect").addEventListener("change", applyFilters);

  el("clearFilters").addEventListener("click", ()=>{
    el("searchInput").value="";
    buildFilters();
    applyFilters();
  });

  el("cartBtn").addEventListener("click", (e)=>{
    e.preventDefault(); e.stopPropagation();
    openCart();
  });
  el("closeCart").addEventListener("click", (e)=>{
    e.preventDefault(); e.stopPropagation();
    closeCart();
  });
  el("drawerBackdrop").addEventListener("click", closeCart);

  el("sendWhatsApp").addEventListener("click", (e)=>{
    e.preventDefault(); e.stopPropagation();
    sendWhatsApp();
  });
  el("clearCart").addEventListener("click", (e)=>{
    e.preventDefault(); e.stopPropagation();
    const ok = confirm("¬øVaciar carrito?");
    if(!ok) return;
    cart = {};
    saveCart();
    updateCartCount();
    renderCart();
  });

  el("importBtn").addEventListener("click", (e)=>{
    e.preventDefault(); e.stopPropagation();
    openImport();
  });

  el("closeImport").addEventListener("click", (e)=>{
    e.preventDefault(); e.stopPropagation();
    closeImport();
  });

  el("doImport").addEventListener("click", (e)=>{
    e.preventDefault(); e.stopPropagation();
    doImportFromTextarea();
  });

  el("clearCatalog").addEventListener("click", (e)=>{
    e.preventDefault(); e.stopPropagation();
    clearCatalogConfirm();
  });

  el("exportCatalog").addEventListener("click", (e)=>{
    e.preventDefault(); e.stopPropagation();
    exportCatalogToClipboard();
  });

  el("downloadCatalogTxt").addEventListener("click", (e)=>{
    e.preventDefault(); e.stopPropagation();
    downloadCatalogTxt();
  });

  el("loadFileBtn").addEventListener("click", (e)=>{
    e.preventDefault(); e.stopPropagation();
    loadCatalogFromFile();
  });

  el("importModal").addEventListener("click", (e)=>{
    if(e.target === el("importModal")) closeImport();
  });

  document.addEventListener("keydown", (e)=>{
    if(e.key === "Escape" && !el("importModal").classList.contains("hidden")){
      closeImport();
    }
  });

  wireLogoLongPress();
}

/* ===================== INIT ===================== */
async function init(){
  wire();
  hideAdminUI();

  await hydrateCatalog();

  // Asegurar type siempre
  ALL = (ALL||[]).map(p=>({
    ...p,
    image: p.image || null,
    type: p.type || detectType(p.name || "")
  }));

  saveCatalogLocal();

  buildFilters();
  filtered = ALL.slice();
  applyFilters();
  updateCartCount();
}

init();
</script>
</body>
</html>
